# Проект: Когортный анализ LTV (Lifetime Value) клиентов интернет-магазина

---

## Введение

**Когортный анализ LTV** — это метод оценки долгосрочной ценности клиентов, который заключается в разделении клиентов на группы (когорты) по времени их первой покупки и дальнейшем отслеживании их покупательского поведения. Такой подход позволяет:

- Точно оценить эффективность маркетинговых кампаний.
- Понять динамику удержания клиентов.
- Прогнозировать будущие доходы.

---

## Цели проекта

Цель проекта — провести глубокий анализ ценности клиентов интернет-магазина через когортный подход. Основные цели:

- **Определить долгосрочную ценность** клиентов различных когорт.
- **Выявить закономерности** в покупательском поведении с течением времени.
- **Определить наиболее ценные когорты** клиентов.
- **Создать основу** для принятия стратегических решений по привлечению и удержанию клиентов.

---

## Задачи проекта

Для достижения целей были поставлены следующие задачи:

- Сформировать когорты клиентов на основе даты первой покупки.
- Рассчитать средние расходы клиентов в различные периоды после первой покупки.
- Проанализировать изменение стоимости жизненного цикла в разрезе когорт.
- Выявить паттерны удержания клиентов и повторных покупок.
- Сформулировать рекомендации по оптимизации маркетинговых стратегий.

---

## Используемые данные

Для анализа использовалась таблица данных онлайн-ритейлера с полями:

| Поле          | Описание              |
|---------------|-----------------------|
| `invoice`     | Номер заказа          |
| `stockcode`   | Артикул товара        |
| `name`        | Наименование товара   |
| `quantity`    | Количество            |
| `datetime`    | Дата и время заказа   |
| `price`       | Цена единицы товара   |
| `customer_id` | Идентификатор клиента |

---

## Методология

Клиенты были сгруппированы по **месяцу первой покупки**, образуя когорты. Для каждой когорты рассчитывались следующие показатели:

- Количество уникальных клиентов в когорте.
- Средняя сумма покупок на клиента:
  - В первый день (0).
  - За первые 30 дней.
  - За первые 60 дней.
  - За первые 90 дней.
  - За первые 180 дней.
  - За первые 300 дней.

---

## Инструменты анализа

- **База данных**: SQL-совместимая СУБД.
- **Язык запросов**: SQL.
- **Используемые конструкции**:
  - Common Table Expressions (CTE).
  - Оконные функции (window functions).
  - Агрегирующие функции.
  - Условные выражения (CASE WHEN).

---

## Реализация SQL-запроса

Ниже представлен SQL-запрос, используемый для когортного анализа:

```sql
with a as( 
select 
    customer_id,
    datetime,
    first_value(to_char(datetime, 'YYYY-MM')) over(partition by customer_id order by datetime) as cohort,
    (datetime - first_value(datetime) over(partition by customer_id order by datetime)) as diff,
    sum(quantity * price) as summ
from online_retail or2 
group by 1, 2
order by 3
)
select 
    cohort,
    count(distinct customer_id),
    round(sum(case when diff = 0 then summ end) / count(distinct customer_id), 2) as "0",
    case when max(diff) > 0 then round(sum(case when diff < 30 then summ end) / count(distinct customer_id), 2) end as "30",
    case when max(diff) > 30 then round(sum(case when diff < 60 then summ end) / count(distinct customer_id), 2) end as "60",
    case when max(diff) > 60 then round(sum(case when diff < 90 then summ end) / count(distinct customer_id), 2) end as "90",
    case when max(diff) > 90 then round(sum(case when diff < 180 then summ end) / count(distinct customer_id), 2) end as "180",
    case when max(diff) > 180 then round(sum(case when diff < 300 then summ end) / count(distinct customer_id), 2) end as "300"
from a
group by 1
```

---

## Структура запроса и логика анализа

### Первый этап (CTE "a"):
- Группировка данных по клиентам и датам покупок.
- Определение когорты для каждого клиента на основе месяца первой покупки.
- Расчёт разницы в днях между каждой покупкой и первой покупкой клиента.
- Вычисление суммы покупки как произведение количества на цену.

### Второй этап (основной запрос):
- Группировка по когортам.
- Подсчёт количества уникальных клиентов в каждой когорте.
- Расчёт средних расходов на клиента за различные периоды (0, 30, 60, 90, 180, 300 дней).
- Округление результатов до 2 знаков после запятой.

---

## Результаты анализа

Результаты представлены в таблице, где:

- **cohort**: месяц первой покупки когорты клиентов.
- **count**: количество уникальных клиентов в когорте.
- **0**: средняя сумма первой покупки клиента.
- **30, 60, 90, 180, 300**: средняя совокупная сумма покупок клиента за соответствующий период в днях.

### Ключевые наблюдения:
-  Самая крупная когорта сформировалась в **декабре 2010 года** (885 клиентов).
-  Наблюдается тенденция к снижению размера когорт в течение 2011 года.
-  LTV клиентов увеличивается с течением времени, что указывает на наличие повторных покупок.
-  Когорта декабря 2011 года показывает наивысшие начальные расходы (659.99), но данные по долгосрочным расходам ограничены.

---

## Выводы

### Динамика когорт
Размер когорт в течение 2011 года имеет тенденцию к снижению, что может указывать на снижение эффективности привлечения новых клиентов.

### Развитие LTV
Для большинства когорт наблюдается стабильный рост LTV с течением времени, что свидетельствует о формировании лояльной клиентской базы.

### Сезонность
Декабрьские когорты (2010-12 и 2011-12) демонстрируют более высокие начальные расходы, что может быть связано с предпраздничными покупками.

### Удержание клиентов
Наблюдается продолжение покупок клиентами в течение длительного периода (до 300 дней), что указывает на эффективность стратегии удержания.

---

## Рекомендации

### Оптимизация маркетинга
Сосредоточить усилия на привлечении клиентов в периоды, показывающие наибольшую долгосрочную ценность.

### Программы лояльности
Внедрить целевые программы лояльности для стимулирования повторных покупок в когортах с высоким потенциалом LTV.

### Сегментация клиентов
Использовать результаты когортного анализа для более точной сегментации клиентской базы и персонализации предложений.

### Мониторинг показателей
Регулярно обновлять когортный анализ для отслеживания изменений в поведении клиентов и эффективности маркетинговых инициатив.

### Углубленный анализ
Дополнить когортный анализ LTV другими метриками (частота покупок, средний чек, маржинальность) для получения более полной картины.
